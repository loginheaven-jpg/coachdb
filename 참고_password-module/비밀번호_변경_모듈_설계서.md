# ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë“ˆ ì„¤ê³„ì„œ

**ë²„ì „**: 1.0  
**ì‘ì„±ì¼**: 2025ë…„ 1ì›” 20ì¼  
**ì‘ì„±ì**: Manus AI  
**ëŒ€ìƒ**: ë°±ì—”ë“œ ê°œë°œì, ì‹œìŠ¤í…œ ì„¤ê³„ì

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜](#ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜)
3. [ê¸°ëŠ¥ ëª…ì„¸](#ê¸°ëŠ¥-ëª…ì„¸)
4. [ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„](#ë°ì´í„°ë² ì´ìŠ¤-ì„¤ê³„)
5. [API ëª…ì„¸](#api-ëª…ì„¸)
6. [ì´ë©”ì¼ í…œí”Œë¦¿](#ì´ë©”ì¼-í…œí”Œë¦¿)
7. [ë³´ì•ˆ ê³ ë ¤ì‚¬í•­](#ë³´ì•ˆ-ê³ ë ¤ì‚¬í•­)
8. [êµ¬í˜„ ê°€ì´ë“œ](#êµ¬í˜„-ê°€ì´ë“œ)
9. [í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤](#í…ŒìŠ¤íŠ¸-ì‹œë‚˜ë¦¬ì˜¤)
10. [ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸](#ë°°í¬-ì²´í¬ë¦¬ìŠ¤íŠ¸)

---

## ê°œìš”

### ëª©ì 

ì´ ë¬¸ì„œëŠ” **ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë“ˆ**ì˜ ì„¤ê³„ ë° êµ¬í˜„ ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ ëª¨ë“ˆì€ ë‹¤ìŒ ì„¸ ê°€ì§€ í•µì‹¬ ê¸°ëŠ¥ì„ í¬í•¨í•˜ë©°, ë‹¤ì–‘í•œ ì‹œìŠ¤í…œì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.

**í•µì‹¬ ê¸°ëŠ¥**:
1. **ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° (Forgot Password)**: ì‚¬ìš©ìê°€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠì–´ë²„ë ¸ì„ ë•Œ ì´ë©”ì¼ë¡œ ì¬ì„¤ì • ë§í¬ë¥¼ ë°œì†¡í•©ë‹ˆë‹¤.
2. **ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • (Reset Password)**: ì´ë©”ì¼ë¡œ ë°›ì€ ë§í¬ë¥¼ í†µí•´ ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
3. **ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (Change Password)**: ë¡œê·¸ì¸ ìƒíƒœì—ì„œ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•œ í›„ ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.

### ì„¤ê³„ ì›ì¹™

**ë³´ì•ˆ ìš°ì„  (Security First)**: ëª¨ë“  ë¹„ë°€ë²ˆí˜¸ëŠ” bcrypt ë˜ëŠ” Argon2ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ì‹œí™”í•˜ë©°, ì¬ì„¤ì • í† í°ì€ ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ ë‚œìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. í† í°ì€ ì¼íšŒìš©ì´ë©° ë§Œë£Œ ì‹œê°„ì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

**ì‚¬ìš©ì ê²½í—˜ (User Experience)**: ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° í”„ë¡œì„¸ìŠ¤ëŠ” ê°„ë‹¨í•˜ê³  ì§ê´€ì ì´ì–´ì•¼ í•˜ë©°, ì´ë©”ì¼ì€ ëª…í™•í•˜ê³  ì¹œê·¼í•œ ì–¸ì–´ë¡œ ì‘ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ì–¸ì œë“ ì§€ í”„ë¡œì„¸ìŠ¤ë¥¼ ì·¨ì†Œí•˜ê±°ë‚˜ ì¬ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì¬ì‚¬ìš©ì„± (Reusability)**: ì´ ëª¨ë“ˆì€ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘í•˜ë©°, ìµœì†Œí•œì˜ ì˜ì¡´ì„±ë§Œ ê°€ì§‘ë‹ˆë‹¤. ë‹¤ë¥¸ ì‹œìŠ¤í…œì— í†µí•©í•  ë•Œ ì„¤ì •ë§Œ ë³€ê²½í•˜ë©´ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.

**í™•ì¥ì„± (Scalability)**: ì´ë©”ì¼ ë°œì†¡, í† í° ì €ì¥, ë¹„ë°€ë²ˆí˜¸ í•´ì‹± ë“± ê° ê¸°ëŠ¥ì€ ë…ë¦½ì ì¸ ëª¨ë“ˆë¡œ ë¶„ë¦¬ë˜ì–´ ìˆì–´ í•„ìš”ì— ë”°ë¼ êµì²´í•˜ê±°ë‚˜ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ê¸°ìˆ  ìŠ¤íƒ

ì´ ì„¤ê³„ì„œëŠ” ë‹¤ìŒ ê¸°ìˆ  ìŠ¤íƒì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìœ¼ë‚˜, ë‹¤ë¥¸ ìŠ¤íƒìœ¼ë¡œë„ ì‰½ê²Œ ì „í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

| êµ¬ì„± ìš”ì†Œ | ê¶Œì¥ ê¸°ìˆ  | ëŒ€ì²´ ê°€ëŠ¥ |
|-----------|-----------|-----------|
| **ë°±ì—”ë“œ í”„ë ˆì„ì›Œí¬** | Node.js + Express / tRPC | Python (FastAPI, Django), Java (Spring Boot) |
| **ë°ì´í„°ë² ì´ìŠ¤** | PostgreSQL | MySQL, MongoDB, SQLite |
| **ORM** | Drizzle ORM / Prisma | TypeORM, Sequelize, SQLAlchemy |
| **ë¹„ë°€ë²ˆí˜¸ í•´ì‹±** | bcrypt | Argon2, scrypt |
| **ì´ë©”ì¼ ë°œì†¡** | Nodemailer / SendGrid | AWS SES, Mailgun, Postmark |
| **í† í° ìƒì„±** | crypto (Node.js) | secrets (Python), SecureRandom (Java) |
| **í”„ë¡ íŠ¸ì—”ë“œ** | React + TypeScript | Vue, Angular, Svelte |

---

## ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ì „ì²´ íë¦„ë„

ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë“ˆì€ ë‹¤ìŒê³¼ ê°™ì€ ì „ì²´ íë¦„ì„ ë”°ë¦…ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° í”Œë¡œìš°                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ì‚¬ìš©ì]
   â”‚
   â”œâ”€ 1. "ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°" í´ë¦­
   â”‚
   â–¼
[í”„ë¡ íŠ¸ì—”ë“œ: ì´ë©”ì¼ ì…ë ¥ í¼]
   â”‚
   â”œâ”€ 2. ì´ë©”ì¼ ì…ë ¥ ë° ì œì¶œ
   â”‚
   â–¼
[ë°±ì—”ë“œ: POST /api/auth/forgot-password]
   â”‚
   â”œâ”€ 3. ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì¦
   â”œâ”€ 4. ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
   â”œâ”€ 5. ì¬ì„¤ì • í† í° ìƒì„± (UUID + ë§Œë£Œ ì‹œê°„)
   â”œâ”€ 6. í† í°ì„ DBì— ì €ì¥
   â”‚
   â–¼
[ì´ë©”ì¼ ì„œë¹„ìŠ¤]
   â”‚
   â”œâ”€ 7. ì¬ì„¤ì • ë§í¬ ì´ë©”ì¼ ë°œì†¡
   â”‚      (ì˜ˆ: https://example.com/reset-password?token=abc123)
   â”‚
   â–¼
[ì‚¬ìš©ì ì´ë©”ì¼]
   â”‚
   â”œâ”€ 8. ì´ë©”ì¼ ìˆ˜ì‹  ë° ë§í¬ í´ë¦­
   â”‚
   â–¼
[í”„ë¡ íŠ¸ì—”ë“œ: ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í¼]
   â”‚
   â”œâ”€ 9. ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ë° ì œì¶œ
   â”‚
   â–¼
[ë°±ì—”ë“œ: POST /api/auth/reset-password]
   â”‚
   â”œâ”€ 10. í† í° ìœ íš¨ì„± ê²€ì¦ (ì¡´ì¬, ë§Œë£Œ, ì‚¬ìš© ì—¬ë¶€)
   â”œâ”€ 11. ìƒˆ ë¹„ë°€ë²ˆí˜¸ í•´ì‹± (bcrypt)
   â”œâ”€ 12. DBì— ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì €ì¥
   â”œâ”€ 13. í† í° ë¬´íš¨í™” (ì‚¬ìš© ì™„ë£Œ í‘œì‹œ)
   â”‚
   â–¼
[í”„ë¡ íŠ¸ì—”ë“œ: ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ]
   â”‚
   â””â”€ 14. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í”Œë¡œìš°                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ë¡œê·¸ì¸ëœ ì‚¬ìš©ì]
   â”‚
   â”œâ”€ 1. "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½" ë©”ë‰´ í´ë¦­
   â”‚
   â–¼
[í”„ë¡ íŠ¸ì—”ë“œ: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í¼]
   â”‚
   â”œâ”€ 2. í˜„ì¬ ë¹„ë°€ë²ˆí˜¸, ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ë° ì œì¶œ
   â”‚
   â–¼
[ë°±ì—”ë“œ: POST /api/auth/change-password]
   â”‚
   â”œâ”€ 3. ì‚¬ìš©ì ì¸ì¦ í™•ì¸ (ì„¸ì…˜/JWT)
   â”œâ”€ 4. í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (bcrypt.compare)
   â”œâ”€ 5. ìƒˆ ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì¦
   â”œâ”€ 6. ìƒˆ ë¹„ë°€ë²ˆí˜¸ í•´ì‹± (bcrypt)
   â”œâ”€ 7. DBì— ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì €ì¥
   â”‚
   â–¼
[ì´ë©”ì¼ ì„œë¹„ìŠ¤]
   â”‚
   â”œâ”€ 8. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì•Œë¦¼ ì´ë©”ì¼ ë°œì†¡
   â”‚
   â–¼
[í”„ë¡ íŠ¸ì—”ë“œ: ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ]
   â”‚
   â””â”€ 9. ëŒ€ì‹œë³´ë“œ ë˜ëŠ” ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™
```

### ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°

ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë“ˆì€ ë‹¤ìŒê³¼ ê°™ì€ ë…ë¦½ì ì¸ ì»´í¬ë„ŒíŠ¸ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.

**1. API Layer (API ê³„ì¸µ)**

ì‚¬ìš©ì ìš”ì²­ì„ ë°›ì•„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í˜¸ì¶œí•˜ê³  ì‘ë‹µì„ ë°˜í™˜í•©ë‹ˆë‹¤. RESTful API ë˜ëŠ” tRPCë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- `POST /api/auth/forgot-password`: ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ìš”ì²­
- `POST /api/auth/reset-password`: ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
- `POST /api/auth/change-password`: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (ì¸ì¦ í•„ìš”)
- `GET /api/auth/verify-reset-token`: í† í° ìœ íš¨ì„± ê²€ì¦ (ì„ íƒì‚¬í•­)

**2. Service Layer (ì„œë¹„ìŠ¤ ê³„ì¸µ)**

ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ê° ê¸°ëŠ¥ì€ ë…ë¦½ì ì¸ ì„œë¹„ìŠ¤ í•¨ìˆ˜ë¡œ êµ¬í˜„ë©ë‹ˆë‹¤.

- `forgotPassword(email: string)`: ì¬ì„¤ì • í† í° ìƒì„± ë° ì´ë©”ì¼ ë°œì†¡
- `resetPassword(token: string, newPassword: string)`: í† í° ê²€ì¦ ë° ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
- `changePassword(userId: string, currentPassword: string, newPassword: string)`: í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ë° ë³€ê²½
- `verifyResetToken(token: string)`: í† í° ìœ íš¨ì„± ê²€ì¦

**3. Data Layer (ë°ì´í„° ê³„ì¸µ)**

ë°ì´í„°ë² ì´ìŠ¤ì™€ ìƒí˜¸ì‘ìš©í•©ë‹ˆë‹¤. ORMì„ ì‚¬ìš©í•˜ì—¬ SQL ì¿¼ë¦¬ë¥¼ ì¶”ìƒí™”í•©ë‹ˆë‹¤.

- `findUserByEmail(email: string)`: ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ì¡°íšŒ
- `findUserById(id: string)`: IDë¡œ ì‚¬ìš©ì ì¡°íšŒ
- `createResetToken(userId: string, token: string, expiresAt: Date)`: ì¬ì„¤ì • í† í° ìƒì„±
- `findResetToken(token: string)`: í† í° ì¡°íšŒ
- `invalidateResetToken(token: string)`: í† í° ë¬´íš¨í™”
- `updateUserPassword(userId: string, hashedPassword: string)`: ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸

**4. Email Service (ì´ë©”ì¼ ì„œë¹„ìŠ¤)**

ì´ë©”ì¼ì„ ë°œì†¡í•©ë‹ˆë‹¤. SMTP, SendGrid, AWS SES ë“± ë‹¤ì–‘í•œ ì´ë©”ì¼ ì œê³µìë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- `sendPasswordResetEmail(email: string, resetLink: string)`: ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ ë°œì†¡
- `sendPasswordChangedEmail(email: string)`: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì•Œë¦¼ ì´ë©”ì¼ ë°œì†¡

**5. Security Utilities (ë³´ì•ˆ ìœ í‹¸ë¦¬í‹°)**

ë¹„ë°€ë²ˆí˜¸ í•´ì‹±, í† í° ìƒì„± ë“± ë³´ì•ˆ ê´€ë ¨ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

- `hashPassword(password: string)`: ë¹„ë°€ë²ˆí˜¸ í•´ì‹± (bcrypt)
- `comparePassword(password: string, hashedPassword: string)`: ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
- `generateResetToken()`: ì•ˆì „í•œ ì¬ì„¤ì • í† í° ìƒì„± (UUID ë˜ëŠ” crypto.randomBytes)
- `validatePassword(password: string)`: ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ê²€ì¦

---

## ê¸°ëŠ¥ ëª…ì„¸

### 1. ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° (Forgot Password)

ì‚¬ìš©ìê°€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠì–´ë²„ë ¸ì„ ë•Œ ì´ë©”ì¼ë¡œ ì¬ì„¤ì • ë§í¬ë¥¼ ë°œì†¡í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

#### ì…ë ¥

| í•„ë“œ | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| `email` | string | âœ… | ì‚¬ìš©ì ì´ë©”ì¼ ì£¼ì†Œ (ìœ íš¨í•œ ì´ë©”ì¼ í˜•ì‹) |

#### ì²˜ë¦¬ ê³¼ì •

**1ë‹¨ê³„: ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì¦**

ì…ë ¥ëœ ì´ë©”ì¼ì´ ìœ íš¨í•œ í˜•ì‹ì¸ì§€ ê²€ì¦í•©ë‹ˆë‹¤. ì •ê·œì‹ `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`ì„ ì‚¬ìš©í•˜ê±°ë‚˜ ë¼ì´ë¸ŒëŸ¬ë¦¬(ì˜ˆ: validator.js)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**2ë‹¨ê³„: ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸**

ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í•´ë‹¹ ì´ë©”ì¼ì„ ê°€ì§„ ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•Šë”ë¼ë„ ë™ì¼í•œ ì„±ê³µ ë©”ì‹œì§€ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤ (íƒ€ì´ë° ê³µê²© ë°©ì§€).

**3ë‹¨ê³„: ê¸°ì¡´ í† í° ë¬´íš¨í™”**

í•´ë‹¹ ì‚¬ìš©ìì˜ ê¸°ì¡´ ì¬ì„¤ì • í† í°ì´ ìˆë‹¤ë©´ ëª¨ë‘ ë¬´íš¨í™”í•©ë‹ˆë‹¤. ì´ëŠ” ì¤‘ë³µ ìš”ì²­ ì‹œ ì´ì „ í† í°ì´ ì‚¬ìš©ë˜ì§€ ì•Šë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

**4ë‹¨ê³„: ì¬ì„¤ì • í† í° ìƒì„±**

ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ ë‚œìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í† í°ì„ ìƒì„±í•©ë‹ˆë‹¤. í† í°ì€ ìµœì†Œ 32ë°”ì´íŠ¸(256ë¹„íŠ¸) ì´ìƒì´ì–´ì•¼ í•˜ë©°, UUID v4 ë˜ëŠ” `crypto.randomBytes(32).toString('hex')`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**5ë‹¨ê³„: í† í° ì €ì¥**

ìƒì„±ëœ í† í°ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•©ë‹ˆë‹¤. í† í°ì—ëŠ” ë‹¤ìŒ ì •ë³´ê°€ í¬í•¨ë©ë‹ˆë‹¤:
- í† í° ê°’ (í•´ì‹œí™” ê¶Œì¥)
- ì‚¬ìš©ì ID
- ìƒì„± ì‹œê°„
- ë§Œë£Œ ì‹œê°„ (ê¸°ë³¸ 1ì‹œê°„)
- ì‚¬ìš© ì—¬ë¶€ (ê¸°ë³¸ false)

**6ë‹¨ê³„: ì´ë©”ì¼ ë°œì†¡**

ì¬ì„¤ì • ë§í¬ë¥¼ í¬í•¨í•œ ì´ë©”ì¼ì„ ì‚¬ìš©ìì—ê²Œ ë°œì†¡í•©ë‹ˆë‹¤. ë§í¬ í˜•ì‹ì€ `https://example.com/reset-password?token={token}`ì…ë‹ˆë‹¤.

#### ì¶œë ¥

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `success` | boolean | í•­ìƒ `true` (ë³´ì•ˆìƒ ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ë¥¼ ë…¸ì¶œí•˜ì§€ ì•ŠìŒ) |
| `message` | string | "ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤." |

#### ì˜¤ë¥˜ ì²˜ë¦¬

| ì˜¤ë¥˜ ì½”ë“œ | HTTP ìƒíƒœ | ì„¤ëª… |
|-----------|-----------|------|
| `INVALID_EMAIL` | 400 | ì´ë©”ì¼ í˜•ì‹ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ |
| `RATE_LIMIT_EXCEEDED` | 429 | ë„ˆë¬´ ë§ì€ ìš”ì²­ (ì˜ˆ: 5ë¶„ ë‚´ 3íšŒ ì´ìƒ) |
| `EMAIL_SEND_FAILED` | 500 | ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ (ë‚´ë¶€ ì˜¤ë¥˜) |

#### ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

**íƒ€ì´ë° ê³µê²© ë°©ì§€**: ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•Šë”ë¼ë„ ë™ì¼í•œ ì²˜ë¦¬ ì‹œê°„ê³¼ ì‘ë‹µì„ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•Šì„ ë•Œë„ ê°€ì§œ í•´ì‹± ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Rate Limiting**: ë™ì¼í•œ ì´ë©”ì¼ ë˜ëŠ” IP ì£¼ì†Œì—ì„œ ì§§ì€ ì‹œê°„ ë‚´ì— ì—¬ëŸ¬ ë²ˆ ìš”ì²­í•˜ëŠ” ê²ƒì„ ì œí•œí•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, 5ë¶„ ë‚´ 3íšŒ ì´ìƒ ìš”ì²­ ì‹œ ì°¨ë‹¨í•©ë‹ˆë‹¤.

**í† í° í•´ì‹±**: í† í°ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•  ë•Œ í•´ì‹œí™”í•˜ì—¬ ì €ì¥í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤. ì´ëŠ” ë°ì´í„°ë² ì´ìŠ¤ê°€ ìœ ì¶œë˜ë”ë¼ë„ í† í°ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

### 2. ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • (Reset Password)

ì´ë©”ì¼ë¡œ ë°›ì€ ë§í¬ë¥¼ í†µí•´ ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

#### ì…ë ¥

| í•„ë“œ | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| `token` | string | âœ… | ì¬ì„¤ì • í† í° (ì´ë©”ì¼ ë§í¬ì—ì„œ ì¶”ì¶œ) |
| `newPassword` | string | âœ… | ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ (ìµœì†Œ 8ì, ëŒ€ì†Œë¬¸ì+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì ê¶Œì¥) |
| `confirmPassword` | string | âœ… | ë¹„ë°€ë²ˆí˜¸ í™•ì¸ (newPasswordì™€ ë™ì¼í•´ì•¼ í•¨) |

#### ì²˜ë¦¬ ê³¼ì •

**1ë‹¨ê³„: í† í° ìœ íš¨ì„± ê²€ì¦**

ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í† í°ì„ ì¡°íšŒí•˜ê³  ë‹¤ìŒì„ í™•ì¸í•©ë‹ˆë‹¤:
- í† í°ì´ ì¡´ì¬í•˜ëŠ”ê°€?
- í† í°ì´ ë§Œë£Œë˜ì§€ ì•Šì•˜ëŠ”ê°€? (ìƒì„± ì‹œê°„ + ìœ íš¨ ê¸°ê°„)
- í† í°ì´ ì´ë¯¸ ì‚¬ìš©ë˜ì§€ ì•Šì•˜ëŠ”ê°€?

**2ë‹¨ê³„: ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì¦**

ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ìŒ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤:
- ìµœì†Œ 8ì ì´ìƒ
- ëŒ€ë¬¸ì, ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¤‘ 3ê°€ì§€ ì´ìƒ í¬í•¨ (ê¶Œì¥)
- `newPassword`ì™€ `confirmPassword`ê°€ ì¼ì¹˜
- ì´ì „ ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¤ë¦„ (ì„ íƒì‚¬í•­)

**3ë‹¨ê³„: ë¹„ë°€ë²ˆí˜¸ í•´ì‹±**

bcryptë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹œí™”í•©ë‹ˆë‹¤. Salt roundsëŠ” 10-12ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.

```typescript
const hashedPassword = await bcrypt.hash(newPassword, 10);
```

**4ë‹¨ê³„: ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸**

ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìƒˆë¡œìš´ í•´ì‹œë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

**5ë‹¨ê³„: í† í° ë¬´íš¨í™”**

ì‚¬ìš©ëœ í† í°ì„ ë¬´íš¨í™”í•˜ì—¬ ì¬ì‚¬ìš©ì„ ë°©ì§€í•©ë‹ˆë‹¤. `usedAt` í•„ë“œë¥¼ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì„¤ì •í•˜ê±°ë‚˜ í† í°ì„ ì‚­ì œí•©ë‹ˆë‹¤.

**6ë‹¨ê³„: ì•Œë¦¼ ì´ë©”ì¼ ë°œì†¡ (ì„ íƒì‚¬í•­)**

ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŒì„ ì•Œë¦¬ëŠ” ì´ë©”ì¼ì„ ì‚¬ìš©ìì—ê²Œ ë°œì†¡í•©ë‹ˆë‹¤. ì´ëŠ” ë³´ì•ˆ ì•Œë¦¼ìœ¼ë¡œ, ì‚¬ìš©ìê°€ ìš”ì²­í•˜ì§€ ì•Šì€ ë³€ê²½ì„ ê°ì§€í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

#### ì¶œë ¥

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `success` | boolean | `true` (ì„±ê³µ ì‹œ) |
| `message` | string | "ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”." |

#### ì˜¤ë¥˜ ì²˜ë¦¬

| ì˜¤ë¥˜ ì½”ë“œ | HTTP ìƒíƒœ | ì„¤ëª… |
|-----------|-----------|------|
| `INVALID_TOKEN` | 400 | í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ |
| `TOKEN_EXPIRED` | 400 | í† í°ì´ ë§Œë£Œë¨ |
| `TOKEN_ALREADY_USED` | 400 | í† í°ì´ ì´ë¯¸ ì‚¬ìš©ë¨ |
| `WEAK_PASSWORD` | 400 | ë¹„ë°€ë²ˆí˜¸ê°€ ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŒ |
| `PASSWORD_MISMATCH` | 400 | ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ |

#### ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

**í† í° ì¼íšŒìš©**: í† í°ì€ í•œ ë²ˆë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ì‚¬ìš© í›„ ì¦‰ì‹œ ë¬´íš¨í™”í•˜ì—¬ ì¬ì‚¬ìš©ì„ ë°©ì§€í•©ë‹ˆë‹¤.

**í† í° ë§Œë£Œ**: í† í°ì€ ìƒì„± í›„ 1ì‹œê°„ ì´ë‚´ì—ë§Œ ìœ íš¨í•©ë‹ˆë‹¤. ë§Œë£Œëœ í† í°ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìœ¼ë©°, ì‚¬ìš©ìëŠ” ë‹¤ì‹œ ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°ë¥¼ ìš”ì²­í•´ì•¼ í•©ë‹ˆë‹¤.

**ë¹„ë°€ë²ˆí˜¸ ê°•ë„**: ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” ì¶©ë¶„íˆ ê°•ë ¥í•´ì•¼ í•©ë‹ˆë‹¤. OWASP ê¶Œì¥ì‚¬í•­ì— ë”°ë¼ ìµœì†Œ 8ì ì´ìƒ, ëŒ€ì†Œë¬¸ì+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•˜ë„ë¡ í•©ë‹ˆë‹¤.

### 3. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (Change Password)

ë¡œê·¸ì¸ ìƒíƒœì—ì„œ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•œ í›„ ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

#### ì…ë ¥

| í•„ë“œ | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| `currentPassword` | string | âœ… | í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ |
| `newPassword` | string | âœ… | ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ |
| `confirmPassword` | string | âœ… | ë¹„ë°€ë²ˆí˜¸ í™•ì¸ |

#### ì²˜ë¦¬ ê³¼ì •

**1ë‹¨ê³„: ì‚¬ìš©ì ì¸ì¦ í™•ì¸**

ìš”ì²­í•œ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ìƒíƒœì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤. ì„¸ì…˜ ë˜ëŠ” JWT í† í°ì„ ê²€ì¦í•˜ì—¬ ì‚¬ìš©ì IDë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.

**2ë‹¨ê³„: í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦**

ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚¬ìš©ìì˜ í•´ì‹œëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¡°íšŒí•˜ê³ , ì…ë ¥ëœ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„êµí•©ë‹ˆë‹¤.

```typescript
const isValid = await bcrypt.compare(currentPassword, user.hashedPassword);
if (!isValid) {
  throw new Error('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
}
```

**3ë‹¨ê³„: ìƒˆ ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì¦**

ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤ (ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •ê³¼ ë™ì¼).

**4ë‹¨ê³„: ë¹„ë°€ë²ˆí˜¸ í•´ì‹± ë° ì—…ë°ì´íŠ¸**

ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹œí™”í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•©ë‹ˆë‹¤.

**5ë‹¨ê³„: ì•Œë¦¼ ì´ë©”ì¼ ë°œì†¡**

ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŒì„ ì•Œë¦¬ëŠ” ì´ë©”ì¼ì„ ì‚¬ìš©ìì—ê²Œ ë°œì†¡í•©ë‹ˆë‹¤.

#### ì¶œë ¥

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `success` | boolean | `true` (ì„±ê³µ ì‹œ) |
| `message` | string | "ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤." |

#### ì˜¤ë¥˜ ì²˜ë¦¬

| ì˜¤ë¥˜ ì½”ë“œ | HTTP ìƒíƒœ | ì„¤ëª… |
|-----------|-----------|------|
| `UNAUTHORIZED` | 401 | ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ì§€ ì•ŠìŒ |
| `INVALID_CURRENT_PASSWORD` | 400 | í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ |
| `WEAK_PASSWORD` | 400 | ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŒ |
| `PASSWORD_MISMATCH` | 400 | ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ |
| `SAME_AS_CURRENT` | 400 | ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë™ì¼ |

#### ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

**í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦**: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œ ë°˜ë“œì‹œ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” ì„¸ì…˜ í•˜ì´ì¬í‚¹ ê³µê²©ì„ ë°©ì§€í•©ë‹ˆë‹¤.

**ì„¸ì…˜ ë¬´íš¨í™” (ì„ íƒì‚¬í•­)**: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í›„ ëª¨ë“  í™œì„± ì„¸ì…˜ì„ ë¬´íš¨í™”í•˜ì—¬ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œì˜ ë¡œê·¸ì¸ì„ ê°•ì œë¡œ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì•Œë¦¼ ì´ë©”ì¼**: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œ ì´ë©”ì¼ ì•Œë¦¼ì„ ë°œì†¡í•˜ì—¬ ì‚¬ìš©ìê°€ ìš”ì²­í•˜ì§€ ì•Šì€ ë³€ê²½ì„ ê°ì§€í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

---

## ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ

ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë“ˆì€ ë‘ ê°œì˜ ì£¼ìš” í…Œì´ë¸”ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

#### 1. users í…Œì´ë¸”

ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤.

```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  hashed_password VARCHAR(255) NOT NULL,
  name VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_users_email ON users(email);
```

**í•„ë“œ ì„¤ëª…**:

| í•„ë“œ | íƒ€ì… | ì œì•½ ì¡°ê±´ | ì„¤ëª… |
|------|------|-----------|------|
| `id` | SERIAL | PRIMARY KEY | ì‚¬ìš©ì ê³ ìœ  ID (ìë™ ì¦ê°€) |
| `email` | VARCHAR(255) | UNIQUE, NOT NULL | ì‚¬ìš©ì ì´ë©”ì¼ (ë¡œê·¸ì¸ ID) |
| `hashed_password` | VARCHAR(255) | NOT NULL | bcryptë¡œ í•´ì‹œëœ ë¹„ë°€ë²ˆí˜¸ |
| `name` | VARCHAR(100) | NULL | ì‚¬ìš©ì ì´ë¦„ |
| `created_at` | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | ê³„ì • ìƒì„± ì‹œê°„ |
| `updated_at` | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ |

#### 2. password_reset_tokens í…Œì´ë¸”

ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í† í°ì„ ì €ì¥í•˜ëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤.

```sql
CREATE TABLE password_reset_tokens (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token VARCHAR(255) UNIQUE NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  used_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_password_reset_tokens_token ON password_reset_tokens(token);
CREATE INDEX idx_password_reset_tokens_user_id ON password_reset_tokens(user_id);
CREATE INDEX idx_password_reset_tokens_expires_at ON password_reset_tokens(expires_at);
```

**í•„ë“œ ì„¤ëª…**:

| í•„ë“œ | íƒ€ì… | ì œì•½ ì¡°ê±´ | ì„¤ëª… |
|------|------|-----------|------|
| `id` | SERIAL | PRIMARY KEY | í† í° ê³ ìœ  ID (ìë™ ì¦ê°€) |
| `user_id` | INTEGER | NOT NULL, FOREIGN KEY | ì‚¬ìš©ì ID (users.id ì°¸ì¡°) |
| `token` | VARCHAR(255) | UNIQUE, NOT NULL | ì¬ì„¤ì • í† í° (í•´ì‹œí™” ê¶Œì¥) |
| `expires_at` | TIMESTAMP | NOT NULL | í† í° ë§Œë£Œ ì‹œê°„ (ìƒì„± ì‹œê°„ + 1ì‹œê°„) |
| `used_at` | TIMESTAMP | NULL | í† í° ì‚¬ìš© ì‹œê°„ (NULLì´ë©´ ë¯¸ì‚¬ìš©) |
| `created_at` | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | í† í° ìƒì„± ì‹œê°„ |

#### 3. password_history í…Œì´ë¸” (ì„ íƒì‚¬í•­)

ì´ì „ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì €ì¥í•˜ì—¬ ì¬ì‚¬ìš©ì„ ë°©ì§€í•˜ëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤.

```sql
CREATE TABLE password_history (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  hashed_password VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_password_history_user_id ON password_history(user_id);
```

**í•„ë“œ ì„¤ëª…**:

| í•„ë“œ | íƒ€ì… | ì œì•½ ì¡°ê±´ | ì„¤ëª… |
|------|------|-----------|------|
| `id` | SERIAL | PRIMARY KEY | íˆìŠ¤í† ë¦¬ ê³ ìœ  ID |
| `user_id` | INTEGER | NOT NULL, FOREIGN KEY | ì‚¬ìš©ì ID |
| `hashed_password` | VARCHAR(255) | NOT NULL | ì´ì „ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ |
| `created_at` | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œê°„ |

### ORM ìŠ¤í‚¤ë§ˆ (Drizzle ORM ì˜ˆì‹œ)

```typescript
import { pgTable, serial, varchar, timestamp, integer } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  hashedPassword: varchar('hashed_password', { length: 255 }).notNull(),
  name: varchar('name', { length: 100 }),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export const passwordResetTokens = pgTable('password_reset_tokens', {
  id: serial('id').primaryKey(),
  userId: integer('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  token: varchar('token', { length: 255 }).notNull().unique(),
  expiresAt: timestamp('expires_at').notNull(),
  usedAt: timestamp('used_at'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

export const passwordHistory = pgTable('password_history', {
  id: serial('id').primaryKey(),
  userId: integer('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  hashedPassword: varchar('hashed_password', { length: 255 }).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});
```

### ë°ì´í„° ì •ë¦¬ (Cleanup)

ë§Œë£Œëœ í† í°ê³¼ ì˜¤ë˜ëœ ë¹„ë°€ë²ˆí˜¸ íˆìŠ¤í† ë¦¬ëŠ” ì •ê¸°ì ìœ¼ë¡œ ì‚­ì œí•´ì•¼ í•©ë‹ˆë‹¤.

**ë§Œë£Œëœ í† í° ì‚­ì œ (ì¼ì¼ ì‹¤í–‰ ê¶Œì¥)**:

```sql
DELETE FROM password_reset_tokens
WHERE expires_at < NOW() - INTERVAL '7 days';
```

**ì˜¤ë˜ëœ ë¹„ë°€ë²ˆí˜¸ íˆìŠ¤í† ë¦¬ ì‚­ì œ (ì›”ê°„ ì‹¤í–‰ ê¶Œì¥)**:

```sql
DELETE FROM password_history
WHERE created_at < NOW() - INTERVAL '1 year';
```

ì´ëŸ¬í•œ ì •ë¦¬ ì‘ì—…ì€ cron job ë˜ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ìë™í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## API ëª…ì„¸

### 1. POST /api/auth/forgot-password

ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ìš”ì²­ì„ ì²˜ë¦¬í•˜ê³  ì¬ì„¤ì • ë§í¬ë¥¼ ì´ë©”ì¼ë¡œ ë°œì†¡í•©ë‹ˆë‹¤.

#### ìš”ì²­

**HTTP Method**: `POST`  
**Endpoint**: `/api/auth/forgot-password`  
**Content-Type**: `application/json`  
**ì¸ì¦**: ë¶ˆí•„ìš”

**Request Body**:

```json
{
  "email": "user@example.com"
}
```

**Request Body Schema**:

```typescript
{
  email: string; // ìœ íš¨í•œ ì´ë©”ì¼ í˜•ì‹
}
```

#### ì‘ë‹µ

**ì„±ê³µ (200 OK)**:

```json
{
  "success": true,
  "message": "ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤."
}
```

**ì˜¤ë¥˜ (400 Bad Request)**:

```json
{
  "success": false,
  "error": "INVALID_EMAIL",
  "message": "ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
}
```

**ì˜¤ë¥˜ (429 Too Many Requests)**:

```json
{
  "success": false,
  "error": "RATE_LIMIT_EXCEEDED",
  "message": "ë„ˆë¬´ ë§ì€ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
}
```

#### êµ¬í˜„ ì˜ˆì‹œ (tRPC)

```typescript
export const authRouter = router({
  forgotPassword: publicProcedure
    .input(z.object({
      email: z.string().email('ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'),
    }))
    .mutation(async ({ input }) => {
      const { email } = input;
      
      // Rate limiting ì²´í¬ (ìƒëµ)
      
      // ì‚¬ìš©ì ì¡°íšŒ
      const user = await findUserByEmail(email);
      
      // ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ë„ ë™ì¼í•œ ì‘ë‹µ ë°˜í™˜ (ë³´ì•ˆ)
      if (!user) {
        return {
          success: true,
          message: 'ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.',
        };
      }
      
      // ê¸°ì¡´ í† í° ë¬´íš¨í™”
      await invalidateUserResetTokens(user.id);
      
      // ìƒˆ í† í° ìƒì„±
      const token = generateResetToken();
      const expiresAt = new Date(Date.now() + 60 * 60 * 1000); // 1ì‹œê°„ í›„
      
      // í† í° ì €ì¥
      await createResetToken(user.id, token, expiresAt);
      
      // ì´ë©”ì¼ ë°œì†¡
      const resetLink = `${process.env.FRONTEND_URL}/reset-password?token=${token}`;
      await sendPasswordResetEmail(user.email, resetLink);
      
      return {
        success: true,
        message: 'ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.',
      };
    }),
});
```

### 2. POST /api/auth/reset-password

ì¬ì„¤ì • í† í°ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

#### ìš”ì²­

**HTTP Method**: `POST`  
**Endpoint**: `/api/auth/reset-password`  
**Content-Type**: `application/json`  
**ì¸ì¦**: ë¶ˆí•„ìš”

**Request Body**:

```json
{
  "token": "abc123def456...",
  "newPassword": "NewSecurePass123!",
  "confirmPassword": "NewSecurePass123!"
}
```

**Request Body Schema**:

```typescript
{
  token: string; // ì¬ì„¤ì • í† í°
  newPassword: string; // ìµœì†Œ 8ì
  confirmPassword: string; // newPasswordì™€ ë™ì¼
}
```

#### ì‘ë‹µ

**ì„±ê³µ (200 OK)**:

```json
{
  "success": true,
  "message": "ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”."
}
```

**ì˜¤ë¥˜ (400 Bad Request - í† í° ë¬´íš¨)**:

```json
{
  "success": false,
  "error": "INVALID_TOKEN",
  "message": "ìœ íš¨í•˜ì§€ ì•Šì€ ì¬ì„¤ì • ë§í¬ì…ë‹ˆë‹¤. ë‹¤ì‹œ ìš”ì²­í•´ì£¼ì„¸ìš”."
}
```

**ì˜¤ë¥˜ (400 Bad Request - í† í° ë§Œë£Œ)**:

```json
{
  "success": false,
  "error": "TOKEN_EXPIRED",
  "message": "ì¬ì„¤ì • ë§í¬ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìš”ì²­í•´ì£¼ì„¸ìš”."
}
```

**ì˜¤ë¥˜ (400 Bad Request - ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜)**:

```json
{
  "success": false,
  "error": "PASSWORD_MISMATCH",
  "message": "ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
}
```

#### êµ¬í˜„ ì˜ˆì‹œ (tRPC)

```typescript
export const authRouter = router({
  resetPassword: publicProcedure
    .input(z.object({
      token: z.string().min(1),
      newPassword: z.string().min(8, 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'),
      confirmPassword: z.string(),
    }))
    .mutation(async ({ input }) => {
      const { token, newPassword, confirmPassword } = input;
      
      // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
      if (newPassword !== confirmPassword) {
        throw new TRPCError({
          code: 'BAD_REQUEST',
          message: 'ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
        });
      }
      
      // í† í° ì¡°íšŒ
      const resetToken = await findResetToken(token);
      
      if (!resetToken) {
        throw new TRPCError({
          code: 'BAD_REQUEST',
          message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì¬ì„¤ì • ë§í¬ì…ë‹ˆë‹¤.',
        });
      }
      
      // í† í° ë§Œë£Œ í™•ì¸
      if (new Date() > resetToken.expiresAt) {
        throw new TRPCError({
          code: 'BAD_REQUEST',
          message: 'ì¬ì„¤ì • ë§í¬ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
        });
      }
      
      // í† í° ì‚¬ìš© ì—¬ë¶€ í™•ì¸
      if (resetToken.usedAt) {
        throw new TRPCError({
          code: 'BAD_REQUEST',
          message: 'ì´ë¯¸ ì‚¬ìš©ëœ ì¬ì„¤ì • ë§í¬ì…ë‹ˆë‹¤.',
        });
      }
      
      // ë¹„ë°€ë²ˆí˜¸ í•´ì‹±
      const hashedPassword = await bcrypt.hash(newPassword, 10);
      
      // ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸
      await updateUserPassword(resetToken.userId, hashedPassword);
      
      // í† í° ë¬´íš¨í™”
      await invalidateResetToken(token);
      
      // ì•Œë¦¼ ì´ë©”ì¼ ë°œì†¡ (ì„ íƒì‚¬í•­)
      const user = await findUserById(resetToken.userId);
      await sendPasswordChangedEmail(user.email);
      
      return {
        success: true,
        message: 'ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.',
      };
    }),
});
```

### 3. POST /api/auth/change-password

ë¡œê·¸ì¸ ìƒíƒœì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.

#### ìš”ì²­

**HTTP Method**: `POST`  
**Endpoint**: `/api/auth/change-password`  
**Content-Type**: `application/json`  
**ì¸ì¦**: í•„ìš” (ì„¸ì…˜ ë˜ëŠ” JWT)

**Request Body**:

```json
{
  "currentPassword": "OldPassword123!",
  "newPassword": "NewSecurePass123!",
  "confirmPassword": "NewSecurePass123!"
}
```

**Request Body Schema**:

```typescript
{
  currentPassword: string; // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸
  newPassword: string; // ìµœì†Œ 8ì
  confirmPassword: string; // newPasswordì™€ ë™ì¼
}
```

#### ì‘ë‹µ

**ì„±ê³µ (200 OK)**:

```json
{
  "success": true,
  "message": "ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."
}
```

**ì˜¤ë¥˜ (401 Unauthorized)**:

```json
{
  "success": false,
  "error": "UNAUTHORIZED",
  "message": "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
}
```

**ì˜¤ë¥˜ (400 Bad Request - í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜)**:

```json
{
  "success": false,
  "error": "INVALID_CURRENT_PASSWORD",
  "message": "í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
}
```

#### êµ¬í˜„ ì˜ˆì‹œ (tRPC)

```typescript
export const authRouter = router({
  changePassword: protectedProcedure // ì¸ì¦ í•„ìš”
    .input(z.object({
      currentPassword: z.string().min(1),
      newPassword: z.string().min(8),
      confirmPassword: z.string(),
    }))
    .mutation(async ({ input, ctx }) => {
      const { currentPassword, newPassword, confirmPassword } = input;
      const userId = ctx.user.id; // ì¸ì¦ëœ ì‚¬ìš©ì ID
      
      // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
      if (newPassword !== confirmPassword) {
        throw new TRPCError({
          code: 'BAD_REQUEST',
          message: 'ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
        });
      }
      
      // ì‚¬ìš©ì ì¡°íšŒ
      const user = await findUserById(userId);
      
      // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
      const isValid = await bcrypt.compare(currentPassword, user.hashedPassword);
      if (!isValid) {
        throw new TRPCError({
          code: 'BAD_REQUEST',
          message: 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
        });
      }
      
      // ìƒˆ ë¹„ë°€ë²ˆí˜¸ í•´ì‹±
      const hashedPassword = await bcrypt.hash(newPassword, 10);
      
      // ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸
      await updateUserPassword(userId, hashedPassword);
      
      // ì•Œë¦¼ ì´ë©”ì¼ ë°œì†¡
      await sendPasswordChangedEmail(user.email);
      
      return {
        success: true,
        message: 'ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.',
      };
    }),
});
```

### 4. GET /api/auth/verify-reset-token (ì„ íƒì‚¬í•­)

ì¬ì„¤ì • í† í°ì˜ ìœ íš¨ì„±ì„ ë¯¸ë¦¬ ê²€ì¦í•©ë‹ˆë‹¤.

#### ìš”ì²­

**HTTP Method**: `GET`  
**Endpoint**: `/api/auth/verify-reset-token?token={token}`  
**ì¸ì¦**: ë¶ˆí•„ìš”

#### ì‘ë‹µ

**ì„±ê³µ (200 OK)**:

```json
{
  "valid": true,
  "message": "ìœ íš¨í•œ ì¬ì„¤ì • ë§í¬ì…ë‹ˆë‹¤."
}
```

**ì˜¤ë¥˜ (400 Bad Request)**:

```json
{
  "valid": false,
  "error": "TOKEN_EXPIRED",
  "message": "ì¬ì„¤ì • ë§í¬ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
}
```

---

## ì´ë©”ì¼ í…œí”Œë¦¿

### 1. ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼

ì‚¬ìš©ìê°€ ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°ë¥¼ ìš”ì²­í–ˆì„ ë•Œ ë°œì†¡ë˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.

#### ì œëª©

```
[ì„œë¹„ìŠ¤ëª…] ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­
```

#### ë³¸ë¬¸ (HTML)

```html
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    .container {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 32px;
    }
    .header {
      text-align: center;
      margin-bottom: 32px;
    }
    .header h1 {
      color: #1a1a1a;
      font-size: 24px;
      margin: 0;
    }
    .content {
      background-color: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .button {
      display: inline-block;
      background-color: #3B82F6;
      color: white;
      text-decoration: none;
      padding: 12px 32px;
      border-radius: 8px;
      font-weight: 600;
      margin: 16px 0;
    }
    .footer {
      text-align: center;
      font-size: 14px;
      color: #666;
    }
    .warning {
      background-color: #FEF3C7;
      border-left: 4px solid #F59E0B;
      padding: 12px;
      margin: 16px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h1>
    </div>
    
    <div class="content">
      <p>ì•ˆë…•í•˜ì„¸ìš”,</p>
      
      <p>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­ì„ ë°›ì•˜ìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
      
      <div style="text-align: center;">
        <a href="{{RESET_LINK}}" class="button">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •í•˜ê¸°</a>
      </div>
      
      <p>ë˜ëŠ” ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ ë¸Œë¼ìš°ì €ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:</p>
      <p style="word-break: break-all; background-color: #f5f5f5; padding: 12px; border-radius: 4px; font-size: 14px;">
        {{RESET_LINK}}
      </p>
      
      <div class="warning">
        <strong>âš ï¸ ì£¼ì˜ì‚¬í•­</strong><br>
        ì´ ë§í¬ëŠ” <strong>1ì‹œê°„ ë™ì•ˆë§Œ ìœ íš¨</strong>í•˜ë©°, í•œ ë²ˆë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
        ìš”ì²­í•˜ì§€ ì•Šìœ¼ì…¨ë‹¤ë©´ ì´ ì´ë©”ì¼ì„ ë¬´ì‹œí•˜ì…”ë„ ë©ë‹ˆë‹¤.
      </div>
    </div>
    
    <div class="footer">
      <p>ì´ ì´ë©”ì¼ì€ ìë™ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. íšŒì‹ í•˜ì§€ ë§ˆì„¸ìš”.</p>
      <p>&copy; 2025 {{SERVICE_NAME}}. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
```

#### ë³¸ë¬¸ (Plain Text)

```
ì•ˆë…•í•˜ì„¸ìš”,

ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.

ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì—¬ ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”:
{{RESET_LINK}}

ì´ ë§í¬ëŠ” 1ì‹œê°„ ë™ì•ˆë§Œ ìœ íš¨í•˜ë©°, í•œ ë²ˆë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ìš”ì²­í•˜ì§€ ì•Šìœ¼ì…¨ë‹¤ë©´ ì´ ì´ë©”ì¼ì„ ë¬´ì‹œí•˜ì…”ë„ ë©ë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.
{{SERVICE_NAME}} íŒ€
```

#### ë³€ìˆ˜

| ë³€ìˆ˜ | ì„¤ëª… | ì˜ˆì‹œ |
|------|------|------|
| `{{RESET_LINK}}` | ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ | `https://example.com/reset-password?token=abc123` |
| `{{SERVICE_NAME}}` | ì„œë¹„ìŠ¤ ì´ë¦„ | `ì½”ì¹˜ì˜ ë‚˜ì¹¨ë°˜` |

### 2. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì•Œë¦¼ ì´ë©”ì¼

ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆì„ ë•Œ ë°œì†¡ë˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.

#### ì œëª©

```
[ì„œë¹„ìŠ¤ëª…] ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤
```

#### ë³¸ë¬¸ (HTML)

```html
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì•Œë¦¼</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    .container {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 32px;
    }
    .header {
      text-align: center;
      margin-bottom: 32px;
    }
    .header h1 {
      color: #1a1a1a;
      font-size: 24px;
      margin: 0;
    }
    .content {
      background-color: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .info-box {
      background-color: #DBEAFE;
      border-left: 4px solid #3B82F6;
      padding: 12px;
      margin: 16px 0;
      font-size: 14px;
    }
    .warning {
      background-color: #FEE2E2;
      border-left: 4px solid #EF4444;
      padding: 12px;
      margin: 16px 0;
      font-size: 14px;
    }
    .footer {
      text-align: center;
      font-size: 14px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>âœ… ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ</h1>
    </div>
    
    <div class="content">
      <p>ì•ˆë…•í•˜ì„¸ìš”,</p>
      
      <p>ê·€í•˜ì˜ ê³„ì • ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      
      <div class="info-box">
        <strong>ğŸ“… ë³€ê²½ ì¼ì‹œ</strong><br>
        {{CHANGED_AT}}
      </div>
      
      <div class="warning">
        <strong>ğŸš¨ ë³¸ì¸ì´ ë³€ê²½í•˜ì§€ ì•Šìœ¼ì…¨ë‚˜ìš”?</strong><br>
        ë³¸ì¸ì´ ìš”ì²­í•˜ì§€ ì•Šì€ ë³€ê²½ì´ë¼ë©´ ì¦‰ì‹œ ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.<br>
        ê³„ì •ì´ í•´í‚¹ë˜ì—ˆì„ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.
      </div>
      
      <p>ê³„ì • ë³´ì•ˆì„ ìœ„í•´ ë‹¤ìŒ ì‚¬í•­ì„ ê¶Œì¥í•©ë‹ˆë‹¤:</p>
      <ul>
        <li>ì •ê¸°ì ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì„¸ìš”</li>
        <li>ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì™€ ë™ì¼í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”</li>
        <li>2ë‹¨ê³„ ì¸ì¦ì„ í™œì„±í™”í•˜ì„¸ìš” (ê°€ëŠ¥í•œ ê²½ìš°)</li>
      </ul>
    </div>
    
    <div class="footer">
      <p>ì´ ì´ë©”ì¼ì€ ìë™ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. íšŒì‹ í•˜ì§€ ë§ˆì„¸ìš”.</p>
      <p>&copy; 2025 {{SERVICE_NAME}}. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
```

#### ë³¸ë¬¸ (Plain Text)

```
ì•ˆë…•í•˜ì„¸ìš”,

ê·€í•˜ì˜ ê³„ì • ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.

ë³€ê²½ ì¼ì‹œ: {{CHANGED_AT}}

ë³¸ì¸ì´ ìš”ì²­í•˜ì§€ ì•Šì€ ë³€ê²½ì´ë¼ë©´ ì¦‰ì‹œ ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.
ê³„ì •ì´ í•´í‚¹ë˜ì—ˆì„ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.

ê³„ì • ë³´ì•ˆì„ ìœ„í•´ ë‹¤ìŒ ì‚¬í•­ì„ ê¶Œì¥í•©ë‹ˆë‹¤:
- ì •ê¸°ì ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì„¸ìš”
- ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì™€ ë™ì¼í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
- 2ë‹¨ê³„ ì¸ì¦ì„ í™œì„±í™”í•˜ì„¸ìš” (ê°€ëŠ¥í•œ ê²½ìš°)

ê°ì‚¬í•©ë‹ˆë‹¤.
{{SERVICE_NAME}} íŒ€
```

#### ë³€ìˆ˜

| ë³€ìˆ˜ | ì„¤ëª… | ì˜ˆì‹œ |
|------|------|------|
| `{{CHANGED_AT}}` | ë³€ê²½ ì¼ì‹œ | `2025ë…„ 1ì›” 20ì¼ ì˜¤í›„ 3:45` |
| `{{SERVICE_NAME}}` | ì„œë¹„ìŠ¤ ì´ë¦„ | `ì½”ì¹˜ì˜ ë‚˜ì¹¨ë°˜` |

---

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 1. ë¹„ë°€ë²ˆí˜¸ í•´ì‹±

**bcrypt ì‚¬ìš©**: bcryptëŠ” ëŠë¦° í•´ì‹± ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ, ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²©(brute-force attack)ì„ ë°©ì§€í•©ë‹ˆë‹¤. Salt roundsëŠ” 10-12ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.

```typescript
import bcrypt from 'bcrypt';

// ë¹„ë°€ë²ˆí˜¸ í•´ì‹±
const hashedPassword = await bcrypt.hash(password, 10);

// ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
const isValid = await bcrypt.compare(password, hashedPassword);
```

**Argon2 ëŒ€ì•ˆ**: Argon2ëŠ” bcryptë³´ë‹¤ ë” ì•ˆì „í•œ ìµœì‹  ì•Œê³ ë¦¬ì¦˜ì…ë‹ˆë‹¤. ê°€ëŠ¥í•˜ë‹¤ë©´ Argon2ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.

```typescript
import argon2 from 'argon2';

// ë¹„ë°€ë²ˆí˜¸ í•´ì‹±
const hashedPassword = await argon2.hash(password);

// ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
const isValid = await argon2.verify(hashedPassword, password);
```

### 2. í† í° ìƒì„±

**ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ ë‚œìˆ˜**: í† í°ì€ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•´ì•¼ í•˜ë¯€ë¡œ `Math.random()`ì´ ì•„ë‹Œ `crypto.randomBytes()`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```typescript
import crypto from 'crypto';

// 32ë°”ì´íŠ¸ (256ë¹„íŠ¸) í† í° ìƒì„±
const token = crypto.randomBytes(32).toString('hex');
```

**UUID v4 ëŒ€ì•ˆ**: UUID v4ë„ ì¶©ë¶„íˆ ì•ˆì „í•©ë‹ˆë‹¤.

```typescript
import { v4 as uuidv4 } from 'uuid';

const token = uuidv4();
```

### 3. í† í° ì €ì¥

**í† í° í•´ì‹± (ê¶Œì¥)**: í† í°ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•  ë•Œ í•´ì‹œí™”í•˜ì—¬ ì €ì¥í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ ìœ ì¶œ ì‹œì—ë„ í† í°ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

```typescript
import crypto from 'crypto';

// í† í° í•´ì‹±
const hashedToken = crypto.createHash('sha256').update(token).digest('hex');

// DBì— hashedToken ì €ì¥
await createResetToken(userId, hashedToken, expiresAt);

// ê²€ì¦ ì‹œ
const hashedInputToken = crypto.createHash('sha256').update(inputToken).digest('hex');
const resetToken = await findResetToken(hashedInputToken);
```

### 4. Rate Limiting

**ìš”ì²­ ì œí•œ**: ë™ì¼í•œ ì´ë©”ì¼ ë˜ëŠ” IP ì£¼ì†Œì—ì„œ ì§§ì€ ì‹œê°„ ë‚´ì— ì—¬ëŸ¬ ë²ˆ ìš”ì²­í•˜ëŠ” ê²ƒì„ ì œí•œí•©ë‹ˆë‹¤.

```typescript
import rateLimit from 'express-rate-limit';

const forgotPasswordLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15ë¶„
  max: 3, // ìµœëŒ€ 3íšŒ
  message: 'ë„ˆë¬´ ë§ì€ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
});

app.post('/api/auth/forgot-password', forgotPasswordLimiter, async (req, res) => {
  // ...
});
```

### 5. íƒ€ì´ë° ê³µê²© ë°©ì§€

**ì¼ì •í•œ ì‘ë‹µ ì‹œê°„**: ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•Šë”ë¼ë„ ë™ì¼í•œ ì²˜ë¦¬ ì‹œê°„ì„ ìœ ì§€í•˜ì—¬ íƒ€ì´ë° ê³µê²©ì„ ë°©ì§€í•©ë‹ˆë‹¤.

```typescript
async function forgotPassword(email: string) {
  const user = await findUserByEmail(email);
  
  if (!user) {
    // ê°€ì§œ í•´ì‹± ì‘ì—…ìœ¼ë¡œ ì²˜ë¦¬ ì‹œê°„ ë§ì¶”ê¸°
    await bcrypt.hash('dummy', 10);
    return { success: true, message: 'ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.' };
  }
  
  // ì‹¤ì œ ì²˜ë¦¬
  // ...
}
```

### 6. HTTPS ì‚¬ìš©

**ëª¨ë“  í†µì‹ ì€ HTTPS**: ë¹„ë°€ë²ˆí˜¸ì™€ í† í°ì€ ë°˜ë“œì‹œ HTTPSë¥¼ í†µí•´ ì „ì†¡ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. HTTPë¥¼ ì‚¬ìš©í•˜ë©´ ì¤‘ê°„ì ê³µê²©(MITM)ì— ì·¨ì•½í•©ë‹ˆë‹¤.

### 7. CSRF ë³´í˜¸

**CSRF í† í°**: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìš”ì²­ì—ëŠ” CSRF í† í°ì„ í¬í•¨í•˜ì—¬ CSRF ê³µê²©ì„ ë°©ì§€í•©ë‹ˆë‹¤.

```typescript
import csrf from 'csurf';

const csrfProtection = csrf({ cookie: true });

app.post('/api/auth/change-password', csrfProtection, async (req, res) => {
  // ...
});
```

### 8. ì„¸ì…˜ ë¬´íš¨í™”

**ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í›„ ì„¸ì…˜ ë¬´íš¨í™”**: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í›„ ëª¨ë“  í™œì„± ì„¸ì…˜ì„ ë¬´íš¨í™”í•˜ì—¬ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œì˜ ë¡œê·¸ì¸ì„ ê°•ì œë¡œ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## êµ¬í˜„ ê°€ì´ë“œ

### Step 1: ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •

**1. ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±**

```sql
-- migrations/001_create_password_reset_tokens.sql

CREATE TABLE password_reset_tokens (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token VARCHAR(255) UNIQUE NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  used_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_password_reset_tokens_token ON password_reset_tokens(token);
CREATE INDEX idx_password_reset_tokens_user_id ON password_reset_tokens(user_id);
CREATE INDEX idx_password_reset_tokens_expires_at ON password_reset_tokens(expires_at);
```

**2. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰**

```bash
# Drizzle ORM
npx drizzle-kit generate
npx drizzle-kit migrate

# Prisma
npx prisma migrate dev --name add_password_reset_tokens
```

### Step 2: ì´ë©”ì¼ ì„œë¹„ìŠ¤ ì„¤ì •

**1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •**

```.env
# SMTP ì„¤ì • (Nodemailer)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

# ë˜ëŠ” SendGrid
SENDGRID_API_KEY=your-sendgrid-api-key

# í”„ë¡ íŠ¸ì—”ë“œ URL
FRONTEND_URL=https://example.com
```

**2. ì´ë©”ì¼ ì„œë¹„ìŠ¤ êµ¬í˜„**

```typescript
// services/email.ts
import nodemailer from 'nodemailer';

const transporter = nodemailer.createTransporter({
  host: process.env.SMTP_HOST,
  port: parseInt(process.env.SMTP_PORT || '587'),
  secure: false,
  auth: {
    user: process.env.SMTP_USER,
    pass: process.env.SMTP_PASS,
  },
});

export async function sendPasswordResetEmail(email: string, resetLink: string) {
  const htmlTemplate = `...`; // ì´ë©”ì¼ í…œí”Œë¦¿
  
  await transporter.sendMail({
    from: '"ì„œë¹„ìŠ¤ëª…" <noreply@example.com>',
    to: email,
    subject: '[ì„œë¹„ìŠ¤ëª…] ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­',
    html: htmlTemplate.replace('{{RESET_LINK}}', resetLink),
  });
}

export async function sendPasswordChangedEmail(email: string) {
  const htmlTemplate = `...`; // ì´ë©”ì¼ í…œí”Œë¦¿
  const changedAt = new Date().toLocaleString('ko-KR');
  
  await transporter.sendMail({
    from: '"ì„œë¹„ìŠ¤ëª…" <noreply@example.com>',
    to: email,
    subject: '[ì„œë¹„ìŠ¤ëª…] ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤',
    html: htmlTemplate.replace('{{CHANGED_AT}}', changedAt),
  });
}
```

### Step 3: API ë¼ìš°í„° êµ¬í˜„

**1. tRPC ë¼ìš°í„° ìƒì„±**

```typescript
// server/routers/auth.ts
import { router, publicProcedure, protectedProcedure } from '../trpc';
import { z } from 'zod';
import bcrypt from 'bcrypt';
import crypto from 'crypto';
import { TRPCError } from '@trpc/server';

export const authRouter = router({
  forgotPassword: publicProcedure
    .input(z.object({ email: z.string().email() }))
    .mutation(async ({ input }) => {
      // êµ¬í˜„ (ìœ„ì˜ API ëª…ì„¸ ì°¸ê³ )
    }),
  
  resetPassword: publicProcedure
    .input(z.object({
      token: z.string(),
      newPassword: z.string().min(8),
      confirmPassword: z.string(),
    }))
    .mutation(async ({ input }) => {
      // êµ¬í˜„ (ìœ„ì˜ API ëª…ì„¸ ì°¸ê³ )
    }),
  
  changePassword: protectedProcedure
    .input(z.object({
      currentPassword: z.string(),
      newPassword: z.string().min(8),
      confirmPassword: z.string(),
    }))
    .mutation(async ({ input, ctx }) => {
      // êµ¬í˜„ (ìœ„ì˜ API ëª…ì„¸ ì°¸ê³ )
    }),
});
```

### Step 4: í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

**1. ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° í˜ì´ì§€**

```typescript
// pages/ForgotPassword.tsx
import { useState } from 'react';
import { trpc } from '@/lib/trpc';
import { toast } from 'sonner';

export default function ForgotPassword() {
  const [email, setEmail] = useState('');
  const forgotPassword = trpc.auth.forgotPassword.useMutation();
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    try {
      await forgotPassword.mutateAsync({ email });
      toast.success('ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    } catch (error) {
      toast.error('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  };
  
  return (
    <form onSubmit={handleSubmit}>
      <input
        type="email"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
        placeholder="ì´ë©”ì¼ ì£¼ì†Œ"
        required
      />
      <button type="submit" disabled={forgotPassword.isLoading}>
        ì¬ì„¤ì • ë§í¬ ë°œì†¡
      </button>
    </form>
  );
}
```

**2. ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í˜ì´ì§€**

```typescript
// pages/ResetPassword.tsx
import { useState } from 'react';
import { useLocation } from 'wouter';
import { trpc } from '@/lib/trpc';
import { toast } from 'sonner';

export default function ResetPassword() {
  const [, setLocation] = useLocation();
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  
  // URLì—ì„œ í† í° ì¶”ì¶œ
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token') || '';
  
  const resetPassword = trpc.auth.resetPassword.useMutation();
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    try {
      await resetPassword.mutateAsync({ token, newPassword, confirmPassword });
      toast.success('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
      setLocation('/login');
    } catch (error) {
      toast.error('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  };
  
  return (
    <form onSubmit={handleSubmit}>
      <input
        type="password"
        value={newPassword}
        onChange={(e) => setNewPassword(e.target.value)}
        placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"
        required
      />
      <input
        type="password"
        value={confirmPassword}
        onChange={(e) => setConfirmPassword(e.target.value)}
        placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
        required
      />
      <button type="submit" disabled={resetPassword.isLoading}>
        ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
      </button>
    </form>
  );
}
```

### Step 5: ì •ë¦¬ ì‘ì—… ìŠ¤ì¼€ì¤„ë§

**1. Cron Job ì„¤ì •**

```typescript
// scripts/cleanup-tokens.ts
import { db } from '../server/db';
import { passwordResetTokens } from '../server/schema';
import { lt } from 'drizzle-orm';

async function cleanupExpiredTokens() {
  const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
  
  const result = await db
    .delete(passwordResetTokens)
    .where(lt(passwordResetTokens.expiresAt, sevenDaysAgo));
  
  console.log(`Deleted ${result.rowCount} expired tokens`);
}

cleanupExpiredTokens();
```

**2. Crontab ë“±ë¡**

```bash
# ë§¤ì¼ ì˜¤ì „ 3ì‹œì— ì‹¤í–‰
0 3 * * * cd /path/to/project && node dist/scripts/cleanup-tokens.js
```

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° í…ŒìŠ¤íŠ¸

| ì‹œë‚˜ë¦¬ì˜¤ | ì…ë ¥ | ì˜ˆìƒ ê²°ê³¼ |
|----------|------|-----------|
| ì •ìƒ ìš”ì²­ | ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ | ì„±ê³µ ë©”ì‹œì§€, ì´ë©”ì¼ ë°œì†¡ |
| ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì´ë©”ì¼ | ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì´ë©”ì¼ | ì„±ê³µ ë©”ì‹œì§€ (ë³´ì•ˆìƒ ë™ì¼) |
| ì˜ëª»ëœ ì´ë©”ì¼ í˜•ì‹ | "invalid-email" | 400 ì˜¤ë¥˜ |
| Rate Limiting | 5ë¶„ ë‚´ 4íšŒ ìš”ì²­ | 429 ì˜¤ë¥˜ |

### 2. ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í…ŒìŠ¤íŠ¸

| ì‹œë‚˜ë¦¬ì˜¤ | ì…ë ¥ | ì˜ˆìƒ ê²°ê³¼ |
|----------|------|-----------|
| ì •ìƒ ì¬ì„¤ì • | ìœ íš¨í•œ í† í° + ìƒˆ ë¹„ë°€ë²ˆí˜¸ | ì„±ê³µ, ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ |
| ë§Œë£Œëœ í† í° | 1ì‹œê°„ ì´ìƒ ê²½ê³¼í•œ í† í° | 400 ì˜¤ë¥˜ (TOKEN_EXPIRED) |
| ì´ë¯¸ ì‚¬ìš©ëœ í† í° | ì‚¬ìš© ì™„ë£Œëœ í† í° | 400 ì˜¤ë¥˜ (TOKEN_ALREADY_USED) |
| ì˜ëª»ëœ í† í° | ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í† í° | 400 ì˜¤ë¥˜ (INVALID_TOKEN) |
| ì•½í•œ ë¹„ë°€ë²ˆí˜¸ | "123456" | 400 ì˜¤ë¥˜ (WEAK_PASSWORD) |
| ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜ | newPassword â‰  confirmPassword | 400 ì˜¤ë¥˜ (PASSWORD_MISMATCH) |

### 3. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í…ŒìŠ¤íŠ¸

| ì‹œë‚˜ë¦¬ì˜¤ | ì…ë ¥ | ì˜ˆìƒ ê²°ê³¼ |
|----------|------|-----------|
| ì •ìƒ ë³€ê²½ | ì˜¬ë°”ë¥¸ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ + ìƒˆ ë¹„ë°€ë²ˆí˜¸ | ì„±ê³µ, ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ |
| ì˜ëª»ëœ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ | í‹€ë¦° í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ | 400 ì˜¤ë¥˜ (INVALID_CURRENT_PASSWORD) |
| ë¯¸ë¡œê·¸ì¸ ìƒíƒœ | ì¸ì¦ ì—†ìŒ | 401 ì˜¤ë¥˜ (UNAUTHORIZED) |
| ë™ì¼í•œ ë¹„ë°€ë²ˆí˜¸ | í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë™ì¼ | 400 ì˜¤ë¥˜ (SAME_AS_CURRENT) |

---

## ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

### í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

- [ ] `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS` ì„¤ì •
- [ ] `FRONTEND_URL` ì„¤ì • (í”„ë¡œë•ì…˜ URL)
- [ ] `DATABASE_URL` ì„¤ì •

### ë°ì´í„°ë² ì´ìŠ¤

- [ ] `password_reset_tokens` í…Œì´ë¸” ìƒì„±
- [ ] ì¸ë±ìŠ¤ ìƒì„± í™•ì¸
- [ ] ì •ë¦¬ ì‘ì—… Cron Job ì„¤ì •

### ë³´ì•ˆ

- [ ] HTTPS ì‚¬ìš© í™•ì¸
- [ ] Rate Limiting ì„¤ì •
- [ ] CSRF ë³´í˜¸ í™œì„±í™”
- [ ] bcrypt Salt rounds 10 ì´ìƒ ì„¤ì •

### ì´ë©”ì¼

- [ ] ì´ë©”ì¼ í…œí”Œë¦¿ í…ŒìŠ¤íŠ¸ (HTML + Plain Text)
- [ ] ë°œì‹ ì ì´ë©”ì¼ ì„¤ì •
- [ ] SPF, DKIM, DMARC ì„¤ì • (ìŠ¤íŒ¸ ë°©ì§€)

### í”„ë¡ íŠ¸ì—”ë“œ

- [ ] ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° í˜ì´ì§€ (`/forgot-password`)
- [ ] ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í˜ì´ì§€ (`/reset-password`)
- [ ] ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í˜ì´ì§€ (`/settings/change-password`)
- [ ] ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ í™•ì¸

### í…ŒìŠ¤íŠ¸

- [ ] ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ (ì°¾ê¸° â†’ ì¬ì„¤ì •)
- [ ] í† í° ë§Œë£Œ í…ŒìŠ¤íŠ¸
- [ ] Rate Limiting í…ŒìŠ¤íŠ¸
- [ ] ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸

---

**ì‘ì„±ì¼**: 2025ë…„ 1ì›” 20ì¼  
**ì‘ì„±ì**: Manus AI  
**ë²„ì „**: 1.0
